# -*- coding: utf-8 -*-
# @Time    : 2023/11/28 16:00
# @Author  : sjh
# @Site    : 
# @File    : CAM.py
# @Comment :
class CAM(nn.Module):
    def __init__(self, inc, fusion='weight'):
        super().__init__()

        assert fusion in ['weight', 'adaptive', 'concat']
        self.fusion = fusion

        self.conv1 = Conv(inc, inc, 3, 1, None, 1, 1)
        self.conv2 = Conv(inc, inc, 3, 1, None, 1, 3)
        self.conv3 = Conv(inc, inc, 3, 1, None, 1, 5)

        self.fusion_1 = Conv(inc, inc, 1)
        self.fusion_2 = Conv(inc, inc, 1)
        self.fusion_3 = Conv(inc, inc, 1)

        if self.fusion == 'adaptive':
            self.fusion_4 = Conv(inc * 3, 3, 1)

    def forward(self, x):
        x1 = self.conv1(x)
        x2 = self.conv2(x)
        x3 = self.conv3(x)

        if self.fusion == 'weight':
            return self.fusion_1(x1) + self.fusion_2(x2) + self.fusion_3(x3)
        elif self.fusion == 'adaptive':
            fusion = torch.softmax(
                self.fusion_4(torch.cat([self.fusion_1(x1), self.fusion_2(x2), self.fusion_3(x3)], dim=1)), dim=1)
            x1_weight, x2_weight, x3_weight = torch.split(fusion, [1, 1, 1], dim=1)
            return x1 * x1_weight + x2 * x2_weight + x3 * x3_weight
        else:
            return torch.cat([self.fusion_1(x1), self.fusion_2(x2), self.fusion_3(x3)], dim=1)
'''
elif m is CAM:
c1, c2 = ch[f], (ch[f] * 3 if args[0] == 'concat' else ch[f])
args = [c1, args[0]]

### yolov5 cam yaml
nc: 80  # number of classes
depth_multiple: 0.33  # model depth multiple
width_multiple: 0.25  # layer channel multiple
anchors:
- [10, 13, 16, 30, 33, 23]  # P3/8
- [30, 61, 62, 45, 59, 119]  # P4/16
- [116, 90, 156, 198, 373, 326]  # P5/32

# YOLOv5 v6.0 backbone
backbone:
# [from, number, module, args]
[[-1, 1, Conv, [64, 6, 2, 2]],  # 0-P1/2
 [-1, 1, Conv, [128, 3, 2]],  # 1-P2/4
 [-1, 3, C3, [128]],
 [-1, 1, Conv, [256, 3, 2]],  # 3-P3/8
 [-1, 6, C3, [256]],
 [-1, 1, Conv, [512, 3, 2]],  # 5-P4/16
 [-1, 9, C3, [512]],
 [-1, 1, Conv, [1024, 3, 2]],  # 7-P5/32
 [-1, 3, C3, [1024]],
 [-1, 1, SPPF, [1024, 5]],  # 9
 ]

# YOLOv5 v6.0 head
head:
[[-1, 1, Conv, [512, 1, 1]],
 [-1, 1, nn.Upsample, [None, 2, 'nearest']],
 [[-1, 6], 1, Concat, [1]],  # cat backbone P4
 [-1, 3, C3, [512, False]],  # 13

 [-1, 1, Conv, [256, 1, 1]],
 [-1, 1, nn.Upsample, [None, 2, 'nearest']],
 [[-1, 4], 1, Concat, [1]],  # cat backbone P3
 [-1, 3, C3, [256, False]],  # 17 (P3/8-small)

 [-1, 1, Conv, [256, 3, 2]],
 [[-1, 14], 1, Concat, [1]],  # cat head P4
 [-1, 3, C3, [512, False]],  # 20 (P4/16-medium)

 [-1, 1, Conv, [512, 3, 2]],
 [10, 1, CAM, ['weight']],
 [[-2, -1], 1, Concat, [1]],  # cat head P5
 [-1, 3, C3, [1024, False]],  # 23 (P5/32-large)

 [[17, 20, 24], 1, Detect, [nc, anchors]],  # Detect(P3, P4, P5)
 ]'''